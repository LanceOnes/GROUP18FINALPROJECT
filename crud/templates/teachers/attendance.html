{% extends 'layout/base.html' %}
{% load static %}

{% block content %}
{% include 'include/sidebar.html' %}

<div class="pt-10 sm:ml-50 px-10">
    
    <div class="glass-container p-4 md:p-6 mb-4 md:mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-white">Attendance Records</h1>
    </div>

    
    <div class="glass-container p-4 md:p-6 mb-4 md:mb-6">
        <h2 class="text-lg md:text-xl font-semibold text-white mb-4 md:mb-6">Filter Records</h2>
        <form method="GET" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
            <div>
                <label for="date" class="block text-sm font-medium text-white/90 mb-2">Date</label>
                <input type="date" id="date" name="date" value="{{ current_date|default:'' }}"
                    class="glass-input w-full rounded-lg bg-[#2a2a3a] text-white/90">
            </div>
            <div>
                <label for="class" class="block text-sm font-medium text-white/90 mb-2">Class</label>
                <select id="class" name="class" class="glass-input w-full rounded-lg bg-[#2a2a3a] text-white/90 [&>option]:bg-[#2a2a3a] py-3 text-lg">
                    <option value="">All Classes</option>
                    {% for class in classes %}
                    <option value="{{ class.id }}" {% if class.id|stringformat:"s" == current_class %}selected{% endif %}>
                        {{ class.subject.name }} - {{ class.section }} ({{ class.room }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="status" class="block text-sm font-medium text-white/90 mb-2">Status</label>
                <select id="status" name="status" class="glass-input w-full rounded-lg bg-[#2a2a3a] text-white/90 [&>option]:bg-[#2a2a3a] py-3 text-lg">
                    <option value="">All Status</option>
                    {% for status_code, status_label in status_choices %}
                    <option value="{{ status_code }}" {% if status_code == current_status %}selected{% endif %}>
                        {{ status_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="glass-button px-4 py-2 rounded-lg font-medium hover:bg-white/20 text-white w-full">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    <div class="glass-container p-4 md:p-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 md:mb-6 space-y-2 md:space-y-0">
            <h2 class="text-lg md:text-xl font-semibold text-white">Attendance Records</h2>
            <p class="text-sm md:text-base text-white/80">Showing {{ attendance_records.start_index|default:"0" }} to {{ attendance_records.end_index|default:"0" }} of {{ total_records }} records</p>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-white text-left">
                <thead>
                    <tr>
                        <th class="p-3 md:p-4 text-sm md:text-base font-medium border-b-2 border-r border-white/20">#</th>
                        <th class="p-3 md:p-4 text-sm md:text-base font-medium border-b-2 border-r border-white/20">Student Name</th>
                        <th class="p-3 md:p-4 text-sm md:text-base font-medium border-b-2 border-r border-white/20">Class</th>
                        <th class="p-3 md:p-4 text-sm md:text-base font-medium border-b-2 border-r border-white/20">Date</th>
                        <th class="p-3 md:p-4 text-sm md:text-base font-medium border-b-2 border-r border-white/20">Time In</th>
                        <th class="p-3 md:p-4 text-sm md:text-base font-medium border-b-2 border-r border-white/20">Status</th>
                        <th class="p-3 md:p-4 text-sm md:text-base font-medium border-b-2 border-white/20 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {% for record in attendance_records %}
                    <tr class="hover:bg-white/5">
                        <td class="p-3 md:p-4 text-white/80 border-r border-white/10">
                            {{ forloop.counter }}
                        </td>
                        <td class="p-3 md:p-4 border-r border-white/10">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm md:text-base text-white font-medium">{{ record.student.get_full_name }}</div>
                                    <div class="text-xs md:text-sm text-white/70">{{ record.student.student_id }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="p-3 md:p-4 border-r border-white/10">
                            <div class="text-sm md:text-base text-white">{{ record.class_instance.subject.code }}</div>
                            <div class="text-xs md:text-sm text-white/70">{{ record.class_instance.section }}</div>
                            <div class="text-xs md:text-sm text-white/70">Room: {{ record.class_instance.room }}</div>
                        </td>
                        <td class="p-3 md:p-4 text-sm md:text-base text-white/80 border-r border-white/10">
                            {{ record.date|date:"l, F j, Y" }}
                        </td>
                        <td class="p-3 md:p-4 border-r border-white/10">
                            <div class="text-sm md:text-base text-white/80">{{ record.time_in|time:"g:i:s A" }}</div>
                        </td>
                        <td class="p-3 md:p-4 border-r border-white/10">
                            <span class="glass-button px-2 py-1 md:px-3 md:py-1 rounded-full text-xs md:text-sm font-medium inline-flex items-center
                                {% if record.status == 'present' %}bg-green-500/20 text-green-100
                                {% elif record.status == 'late' %}bg-yellow-500/20 text-yellow-100
                                {% else %}bg-red-500/20 text-red-100{% endif %}">
                                {{ record.status|title }}
                            </span>
                        </td>
                        <td class="p-3 md:p-4 text-right">
                            <div class="flex items-center justify-end gap-2 md:gap-3">
                                <a href="{% url 'edit_attendance' record.id %}" class="glass-button p-1.5 md:p-2 rounded-lg hover:bg-white/20">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 md:h-4 md:w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </a>
                                <button onclick="confirmDelete('{% url 'delete_attendance' record.id %}')" class="glass-button p-1.5 md:p-2 rounded-lg hover:bg-red-500/20">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 md:h-4 md:w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="p-6 md:p-8 text-center">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 md:w-16 md:h-16 bg-white/10 rounded-full flex items-center justify-center mb-4">
                                    <svg class="w-6 h-6 md:w-8 md:h-8 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg md:text-xl font-semibold text-white mb-2">No Records Found</h3>
                                <p class="text-sm text-white/70">No attendance records found matching your criteria.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if attendance_records.has_other_pages %}
        <div class="mt-4 md:mt-6 flex items-center justify-between">
            <div class="flex-1 flex justify-between">
                {% if attendance_records.has_previous %}
                <a href="?page={{ attendance_records.previous_page_number }}{% if current_date %}&date={{ current_date }}{% endif %}{% if current_class %}&class={{ current_class }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}"
                    class="glass-button px-3 py-1.5 md:px-4 md:py-2 rounded-lg hover:bg-white/20 text-sm md:text-base text-white">
                    Previous
                </a>
                {% endif %}
                {% if attendance_records.has_next %}
                <a href="?page={{ attendance_records.next_page_number }}{% if current_date %}&date={{ current_date }}{% endif %}{% if current_class %}&class={{ current_class }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}"
                    class="glass-button px-3 py-1.5 md:px-4 md:py-2 rounded-lg hover:bg-white/20 text-sm md:text-base text-white">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#1a1b26] rounded-xl p-6 max-w-sm w-full mx-4">
        <h3 class="text-xl font-semibold text-white mb-4">Confirm Delete</h3>
        <p class="text-white/70 mb-6">Are you sure you want to delete this attendance record? This action cannot be undone.</p>
        <div class="flex justify-end gap-4">
            <button onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg text-white/90 hover:text-white">
                Cancel
            </button>
            <a href="#" id="deleteConfirmButton" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                Delete
            </a>
        </div>
    </div>
</div>

<script>
    function confirmDelete(deleteUrl) {
        const modal = document.getElementById('deleteModal');
        const deleteButton = document.getElementById('deleteConfirmButton');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        deleteButton.href = deleteUrl;
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Close modal when clicking outside
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
</script>
{% endblock %}
